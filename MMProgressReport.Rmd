---
title: "Montgomery County Traffic Incidents"
author: "Michael Metzler"
date: "`r Sys.Date()`"
output: powerpoint_presentation
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = FALSE, fig.width = 12, fig.height = 6, dpi = 300)
library(tidyverse)
library(lubridate)
library(leaflet)
incidents <- feather::read_feather("incidents.feather")
drivers <- feather::read_feather("drivers.feather")
non_motorists <- feather::read_feather("non_motorists.feather")
single_color <- "#3182bd"
basic_theme <- theme(
  plot.title = element_text(size = 24, vjust = .5, hjust = .5),
  axis.title = element_text(size = 16, hjust = .5, vjust = .5),
  panel.background = element_rect(fill = "white"),
  legend.position = "none",
  panel.grid.major.y = element_line(color = "grey75", size = .1, linetype = "solid")
)
```

## Automated Crash Reporting System

- 3 Datasets (Incidents, Drivers, Non-Motorists)
- `r nrow(incidents)` incidents since January 1st 2015
- `r nrow(drivers)` drivers
- `r nrow(non_motorists)` non-motorists
- The data is mostly categorical or descriptions
- Variety of NA encodings in the data (N/A, NA, empty strings)

## Data Cleaning and Wrangling

- Identifyied data points with geolocation not in the county
- Use One-Hot encoding to create dummy variables for certain categorical variables
- Combine the incidents, drivers, and non-motorists tables into a single combined table with count data per incident


## Types of Incidents

```{r incidenttypes}
incidents %>%
  group_by(acrs_report_type) %>%
  count() %>%
  rename(`Report Type` = acrs_report_type, Incidents = n) %>%
  knitr::kable()
```

## Weather

```{r incidentsweather}
incidents %>%
  group_by(weather) %>%
  count() %>%
  arrange(desc(n)) %>%
  knitr::kable()
```

```{r}
incidents %>%
  select(incident_year) %>%
  ggplot() +
  stat_count(aes(x = incident_year), fill = single_color) +
  ggtitle("Crashes by Year") +
  ylab("") +
  basic_theme
```

## Number of Crashes by Date
```{r}
incidents %>%
  filter(incident_year < 2019) %>%
  select(incident_month, incident_day) %>%
  mutate(incident_date = paste0(incident_month, "/", incident_day)) %>%
  count(incident_date) %>%
  arrange(desc(n)) %>%
  mutate(Rank = row_number()) %>%
  rename(Date = incident_date, `Number of Crashes` = n) %>%
  filter((Rank < 6) | Date %in% c("12/25", "7/4", "12/26", "12/31", "1/1")) %>%
  knitr::kable()
```

```{r}
incidents %>%
  select(incident_hour, incident_minute) %>%
  mutate(incident_time = 60 * incident_hour + incident_minute) %>%
  ggplot() +
  stat_count(aes(x = incident_time), fill = single_color) +
  scale_x_continuous(
    name = "Time",
    breaks = seq.int(from = 0, to = 24 * 60, by = 120),
    labels = c(paste0(seq.int(from = 0, to = 22, by = 2), ":00"), "0:00")
  ) +
  ggtitle("Crashes by Time of Day") +
  ylab("") +
  basic_theme
```

```{r}
incidents %>%
  select(incident_weekday) %>%
  ggplot() +
  stat_count(aes(x = incident_weekday), fill = single_color) +
  scale_x_continuous(
    name = "Day of Week",
    breaks = 1:7,
    labels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thurday", "Friday", "Saturday")
  ) +
  ggtitle("Crashes by Day of Week") +
  ylab("") +
  basic_theme
```

```{r}
incidents %>%
  filter(driver_substance_abuse_alcohol_present | driver_substance_abuse_alcohol_contributed) %>%
  select(incident_hour, incident_minute) %>%
  mutate(incident_time = 60 * incident_hour + incident_minute) %>%
  ggplot() +
  stat_count(aes(x = incident_time), fill = single_color) +
  scale_x_continuous(
    name = "Time",
    breaks = seq.int(from = 0, to = 24 * 60, by = 120),
    labels = paste0(seq.int(from = 0, to = 24, by = 2), ":00")
  ) +
  ggtitle("Crashes Involving Alcohol by Time of Day") +
  ylab("") +
  basic_theme
```

```{r}
incidents %>%
  filter(driver_substance_abuse_alcohol_present | driver_substance_abuse_alcohol_contributed) %>%
  select(incident_weekday) %>%
  ggplot() +
  stat_count(aes(x = incident_weekday), fill = single_color) +
  scale_x_continuous(
    name = "Day of Week",
    breaks = 1:7,
    labels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thurday", "Friday", "Saturday")
  ) +
  ggtitle("Crashes Involving Alcohol by Day of Week") +
  ylab("") +
  basic_theme
```

```{r}
ordered_levels <- drivers %>%
  count(injury_severity) %>%
  arrange(desc(n)) %>%
  pull(injury_severity)
drivers %>%
  mutate(`Injury Severity` = factor(injury_severity, ordered_levels)) %>%
  ggplot() +
  stat_count(aes(x = `Injury Severity`), fill = single_color) +
  ggtitle("Severity of Driver Injuries") +
  ylab("") +
  basic_theme
```

```{r}
ordered_levels <- drivers %>%
  count(vehicle_damage_extent) %>%
  arrange(desc(n)) %>%
  pull(vehicle_damage_extent)
drivers %>%
  mutate(`Vehicle Damage` = factor(vehicle_damage_extent, ordered_levels)) %>%
  ggplot() +
  stat_count(aes(x = `Vehicle Damage`), fill = single_color) +
  ggtitle("Severity of Vehicle Damage") +
  ylab("") +
  basic_theme
```

```{r}
drivers %>%
  ggplot() +
  stat_count(aes(x = speed_limit, fill = ), fill = single_color) +
  ggtitle("Speed Limits") +
  ylab("") +
  basic_theme
```

```{r}
ordered_injury <- drivers %>%
  count(injury_severity) %>%
  arrange(desc(n)) %>%
  pull(injury_severity)
drivers %>%
  mutate(
    speed_limit = factor(c("Under 35", "35 - 45", "50+")[1 + findInterval(speed_limit, c(31, 46))], levels = c("Under 35", "35 - 45", "50+")),
    injury_severity = factor(injury_severity, ordered_injury)
  ) %>%
  group_by(speed_limit, injury_severity) %>%
  tally() %>%
  rename(`Speed Limit` = speed_limit, `Injury Severity` = injury_severity) %>%
  ggplot() +
  geom_bin2d(aes(x = `Speed Limit`, fill = log(n), y = `Injury Severity`)) +
  geom_text(aes(x = `Speed Limit`, label = n, y = `Injury Severity`)) +
  basic_theme +
  scale_fill_gradient(
    low = "#ece7f2",
    high = "#a6bddb"
  ) +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Driver Injuries and Speed Limits")
```

```{r}
ordered_levels <- non_motorists %>%
  count(pedestrian_type) %>%
  arrange(desc(n)) %>%
  pull(pedestrian_type)
non_motorists %>%
  mutate(pedestrian_type = factor(pedestrian_type, ordered_levels)) %>%
  ggplot() +
  stat_count(aes(x = pedestrian_type), fill = single_color) +
  basic_theme +
  ylab("") +
  xlab("") +
  ggtitle("Types of Non-Motorists")
```

```{r}
ordered_levels <- non_motorists %>%
  count(injury_severity) %>%
  arrange(desc(n)) %>%
  pull(injury_severity)
non_motorists %>%
  mutate(`Injury Severity` = factor(injury_severity, ordered_levels)) %>%
  ggplot() +
  stat_count(aes(x = `Injury Severity`), fill = single_color) +
  ggtitle("Severity of Non-Motorist Injuries") +
  ylab("") +
  basic_theme
```
