---
title: "Analysis"
author: "Michael Metzler"
date: "11/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 12, fig.height = 6, dpi = 300)
```

```{r loadlibs}
library(tidyverse)
library(magrittr)
```


```{r loaddata}
drivers <- feather::read_feather("drivers.feather")
incidents <- feather::read_feather("incidents.feather")
non_motorists <- feather::read_feather("non_motorists.feather")
combo <- feather::read_feather("combo.feather")
```

```{r kmeans}
incident_locations <- incidents %>%
  filter(!not_in_county) %>%
  select(longitude, latitude)
kmeans_list <- lapply(1:15,function(x)kmeans(incident_locations, centers = x, nstart = 25, iter.max = 100))
centroidss <- data.frame(
  centroids = 1:15,
  sum_of_squares = sapply(1:15,function(x)kmeans_list[[x]]$tot.withinss)
  )
centroidss %>%
  ggplot(aes(x = centroids, y = sum_of_squares)) +
  geom_line()
```
```{r centroidtable}
centroidss %>% knitr::kable()
```


```{r clusterplots}
incident_clusters <- incident_locations
for(x in 1:15){
  incident_clusters$cluster <- 
    as.factor(paste0("cluster", kmeans_list[[x]]$cluster))
  temp <-incident_clusters %>%
    ggplot(aes(x = longitude, y = latitude, color = cluster)) +
    geom_point()
  temp %>% print()
}
```

```{r ctfunction}
contingency_table <- function(data, var1, var2){
data %>%
  group_by(!!enquo(var1), !!enquo(var2)) %>%
  tally() %>%
  ggplot() +
  geom_bin2d(aes(x = !!enquo(var1), fill = log(n), y = !!enquo(var2))) +
  geom_text(aes(x = !!enquo(var1), label = n, y = !!enquo(var2))) +
  scale_fill_gradient(low = "#ece7f2",
                      high = "#a6bddb") +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    panel.background = element_rect(fill = "white")
    )
}
```


```{r weatherchisq}
temp <-chisq.test(as.factor(incidents$weather), as.factor(incidents$acrs_report_type))
temp %>% broom::tidy() %>% knitr::kable()
```

p-value `r temp$p.value`
```{r weathertable}
contingency_table(incidents, acrs_report_type, weather)
```

## Helmets

```{r helmetchisq}
helmet_data <- non_motorists %>%
  filter(as.logical(pedestrian_type_bicyclist)) %>%
  select(safety_equipment,injury_severity) %>%
  mutate(safety_equipment = c("no helmet","helmet")[1+as.integer(str_detect(tolower(safety_equipment), "helmet"))])

temp <-chisq.test(as.factor(helmet_data$safety_equipment), as.factor(helmet_data$injury_severity))
temp %>% broom::tidy() %>% knitr::kable()
```

```{r helmettable}
contingency_table(helmet_data, safety_equipment,injury_severity)
```


## Speed Limits

```{r speedchisq}
ordered_injury <- drivers %>%
  count(injury_severity) %>%
  arrange(desc(n)) %>%
  pull(injury_severity)

speed_limit_data <-drivers %>%
  select(speed_limit,injury_severity) %>%
  mutate(
    speed_limit = factor(c("Under 35", "35 - 45", "50+")[1 + findInterval(speed_limit, c(31, 46))], levels = c("Under 35", "35 - 45", "50+")),
    injury_severity = factor(injury_severity, ordered_injury)
  )

temp <-chisq.test(as.factor(speed_limit_data$speed_limit), as.factor(speed_limit_data$injury_severity))
temp %>% broom::tidy() %>% knitr::kable()
```

p-value `r temp$p.value`

```{r speedtable}
contingency_table(speed_limit_data, speed_limit, injury_severity)
```
```{r prophetall, echo=FALSE}
library(prophet)
temp_data <- incidents %>%
  count(incident_date) %>% 
  rename(ds = incident_date, y = n)
total_model <- prophet(mcmc.samples = 100, fit = FALSE) %>%
  add_country_holidays("US") %>%
  fit.prophet(df = temp_data)
future <- total_model %>% make_future_dataframe(periods = 365)
forecast <- predict(total_model, future)
```

```{r}
plot(total_model, forecast)
```

```{r}
prophet_plot_components(total_model, forecast)
```

```{r alcoholprophet, echo=FALSE}
temp_data <- incidents %>%
  filter(driver_substance_abuse_alcohol_present | driver_substance_abuse_alcohol_contributed) %>% 
  count(incident_date) %>% 
  rename(ds = incident_date, y = n)
alcohol_model <- prophet(mcmc.samples = 100) %>%
  add_country_holidays("US") %>%
  fit.prophet(df = temp_data)
future <- alcohol_model %>% make_future_dataframe(periods = 365)
forecast <- predict(alcohol_model, future)
```

```{r}
plot(alcohol_model, forecast)
```

```{r}
prophet_plot_components(alcohol_model, forecast)
```

